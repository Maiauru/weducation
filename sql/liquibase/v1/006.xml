<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <changeSet id="006-1" author="gooamoko">
        <comment>
            Добавим таблицу заявок на обучение персон по специальностям
        </comment>
        <sql>
            CREATE TABLE requests (
            req_pcode serial,
            req_psncode int NOT NULL,
            req_spccode int NOT NULL,
            req_year int NOT NULL,
            req_extramural boolean NOT NULL,
            CONSTRAINT unique_requests UNIQUE(req_psncode, req_spccode, req_year, req_extramural),
            CONSTRAINT requests_pk PRIMARY KEY(req_pcode),
            CONSTRAINT requests_persons_fk FOREIGN KEY(req_psncode) REFERENCES persons(psn_pcode) ON UPDATE CASCADE ON DELETE CASCADE,
            CONSTRAINT requests_specialities_fk FOREIGN KEY(req_spccode) REFERENCES specialities(spc_pcode) ON UPDATE CASCADE ON DELETE CASCADE);
        </sql>
    </changeSet>
    <changeSet id="006-2" author="gooamoko">
        <comment>
            Удалим старую и уже ненужную таблицу contests
        </comment>
        <sql>
            DROP TABLE contests;
        </sql>
    </changeSet>
    <changeSet id="006-3" author="gooamoko">
        <comment>
            Добавим в таблицу специальности столбец spc_aviable
        </comment>
        <sql>
            ALTER TABLE specialities ADD COLUMN spc_aviable boolean NOT NULL DEFAULT false;
        </sql>
    </changeSet>
    <changeSet id="006-4" author="gooamoko">
        <comment>
            Удалим из таблицы pmarks столбец pmk_length
        </comment>
        <sql>
            ALTER TABLE pmarks DROP COLUMN pmk_length;
        </sql>
    </changeSet>
    <changeSet id="006-5" author="gooamoko">
        <comment>
            Создадим фукцию int getDate(int year, int month, int week) для вычисления даты
        </comment>
        <sql splitStatements="false" stripComments="false">
            CREATE FUNCTION getDate(year int, month int, week int) RETURNS int AS '
            SELECT (year * 1000 + month * 10 + week);' LANGUAGE SQL;
        </sql>
    </changeSet>
    <changeSet id="006-6" author="gooamoko">
        <comment>
            Создадим фукцию для очистки "старых" оценок
        </comment>
        <sql splitStatements="false" stripComments="false">
            CREATE OR REPLACE FUNCTION clearOldGroupMarks(groupId integer) RETURNS void AS '
            DELETE FROM fmarks WHERE fmk_subcode NOT IN (SELECT sub_pcode FROM subjects, groups 
            WHERE (sub_plncode = grp_plncode) AND (grp_pcode = groupId)) 
            AND (fmk_crdcode IN (SELECT crd_pcode FROM cards WHERE (crd_grpcode = groupId)));
            DELETE FROM fmarks WHERE fmk_modcode NOT IN (SELECT mod_pcode FROM modules, groups 
            WHERE (mod_plncode = grp_plncode) AND (grp_pcode = groupId)) 
            AND (fmk_crdcode IN (SELECT crd_pcode FROM cards WHERE (crd_grpcode = groupId)));
            DELETE FROM cmarks WHERE cmk_subcode NOT IN (SELECT sub_pcode FROM subjects, groups 
            WHERE (sub_plncode = grp_plncode) AND (grp_pcode = groupId)) 
            AND (cmk_crdcode IN (SELECT crd_pcode FROM cards WHERE (crd_grpcode = groupId)));
            DELETE FROM fpmarks WHERE fpm_fpccode NOT IN (SELECT fpc_pcode FROM finalpractics, groups 
            WHERE (fpc_plncode = grp_plncode) AND (grp_pcode = groupId)) 
            AND (fpm_crdcode IN (SELECT crd_pcode FROM cards WHERE (crd_grpcode = groupId)));
            DELETE FROM gmarks WHERE gmk_subcode NOT IN (SELECT sub_pcode FROM subjects, groups 
            WHERE (sub_plncode = grp_plncode) AND (grp_pcode = groupId)) 
            AND (gmk_crdcode IN (SELECT crd_pcode FROM cards WHERE (crd_grpcode = groupId)));
            DELETE FROM pmarks WHERE pmk_prccode NOT IN (SELECT prc_pcode FROM practics, groups 
            WHERE (prc_plncode = grp_plncode) AND (grp_pcode = groupId)) 
            AND (pmk_crdcode IN (SELECT crd_pcode FROM cards WHERE (crd_grpcode = groupId)));
            DELETE FROM monthmarks WHERE mmk_subcode NOT IN (SELECT sub_pcode FROM subjects, groups 
            WHERE (sub_plncode = grp_plncode) AND (grp_pcode = groupId)) 
            AND (mmk_crdcode IN (SELECT crd_pcode FROM cards WHERE (crd_grpcode = groupId)));
            ' LANGUAGE SQL;
        </sql>
    </changeSet>
    <changeSet id="006-7" author="gooamoko">
        <comment>
            Создадим вьюху для упрощения подсчета среднего балла
        </comment>
        <sql splitStatements="false" stripComments="false">
            <![CDATA[
            CREATE OR REPLACE VIEW fmarkview AS 
            SELECT 1 AS fmv_id, fmk_crdcode AS fmv_crdcode, SUM(fmk_mark) AS fmv_total, COUNT(fmk_mark) AS fmv_count 
            FROM fmarks WHERE (fmk_mark IS NOT NULL) AND (fmk_mark >= 0) AND (fmk_mark <= 5) GROUP BY fmk_crdcode 
            UNION SELECT 2, cmk_crdcode, SUM(cmk_mark), COUNT(cmk_mark) 
            FROM cmarks WHERE (cmk_mark IS NOT NULL) AND (cmk_mark >= 0) AND (cmk_mark <= 5) GROUP BY cmk_crdcode 
            UNION SELECT 3, fpm_crdcode, SUM(fpm_mark), COUNT(fpm_mark) 
            FROM fpmarks WHERE (fpm_mark IS NOT NULL) AND (fpm_mark >= 0) AND (fpm_mark <= 5) GROUP BY fpm_crdcode 
            UNION SELECT 4, gmk_crdcode, SUM(gmk_mark), COUNT(gmk_mark) 
            FROM gmarks WHERE (gmk_mark IS NOT NULL) AND (gmk_mark >= 0) AND (gmk_mark <= 5) GROUP BY gmk_crdcode;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="006-8" author="gooamoko">
        <comment>
            Создадим фукцию для вычисления среднего балла
        </comment>
        <sql splitStatements="false" stripComments="false">
            CREATE OR REPLACE FUNCTION getAverageMark(cardId integer) RETURNS decimal(3,2) AS ' 
            SELECT CAST(CAST(SUM(fmv_total) AS decimal(5,2)) / SUM(fmv_count) AS decimal(3,2)) FROM fmarkview 
            WHERE (fmv_crdcode = cardId);' LANGUAGE sql;
        </sql>
    </changeSet>
    <changeSet id="006-9" author="gooamoko">
        <comment>
            Создадим функцию для вычисления 
        </comment>
        <sql splitStatements="false" stripComments="false">
            CREATE OR REPLACE FUNCTION countMarks(personId int) RETURNS bigint AS ' 
            SELECT (SELECT COUNT(*) FROM monthmarks WHERE mmk_psncode = personId) + 
            (SELECT COUNT(*) FROM fmarks, persons, cards WHERE (crd_pcode = fmk_crdcode) AND (psn_pcode = crd_psncode) AND (psn_pcode = personId));
            ' LANGUAGE SQL;
        </sql>
    </changeSet>
    <changeSet id="006-10" author="gooamoko">
        <comment>
            Создадим вьюху для отображения персон с подозрением на дублирование
        </comment>
        <sql splitStatements="false" stripComments="false">
            CREATE OR REPLACE VIEW dublicates AS
            SELECT psn_firstname AS dbl_fname, psn_middlename AS dbl_mname, psn_lastname dbl_lname, psn_birthdate AS dbl_birthdate, 
            COUNT(psn_pcode) AS dbl_count
            FROM persons WHERE (substring(psn_firstname, 1, 3) IN (SELECT DISTINCT substring(psn_firstname, 1, 3) FROM persons)) 
            GROUP BY psn_firstname, psn_middlename, psn_lastname, psn_birthdate 
            HAVING (COUNT(psn_pcode) > 1)
            ORDER BY dbl_count DESC, psn_firstname;
        </sql>
    </changeSet>    
</databaseChangeLog>